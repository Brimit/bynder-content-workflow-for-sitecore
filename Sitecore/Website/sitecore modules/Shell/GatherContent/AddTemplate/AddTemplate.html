<script src="/sitecore modules/shell/GatherContent/jquery_2.1.1.min.js"></script>
<script src="/sitecore/shell/Controls/Lib/Prototype/prototype.js"></script>
<script src="/sitecore/shell/Controls/Browser.js"></script>
<script src="/sitecore/shell/Controls/Sitecore.js"></script>
<script src="/sitecore modules/shell/GatherContent/GatherContent.js"></script>
<script src="/js/knockout-3.4.0.js"></script>
<link href="/sitecore modules/shell/GatherContent/GatherContent.css" rel="stylesheet" />
<script type="text/javascript">
    $.noConflict();
</script>
<script type="text/JavaScript" language="javascript">
    if (!window.scSitecore) {
        scSitecore = function () { };
    }
    scSitecore.prototype.Settings = {};
    scSitecore.prototype.Settings.SessionTimeout = 1200000;
</script>

<div class="gathercontent-dialog">
    <h1>
        Choose template to map to Sitecore
    </h1>
    <small>You can map templates from multiple GatherContent projects into Sitecore</small>
    <h2>
        If you need help with setting this up please contact support@gathercontent.com
    </h2>


    <ul data-bind="foreach: { data: Projects }" style="list-style: none;">
        <li class="project-item">
            <span data-bind="text: ProjectName"> </span>
            <ul data-bind="foreach: { data: Templates, as: 'item' }" style="display: none; list-style: none;">
                <li>
                    <div>
                        <input type="checkbox" data-bind="value:item.TemplateId, checked: $root.Selected, attr: { id: item.TemplateName}" />
                        <!--<input type="checkbox" data-bind="value:item.TemplateId, checked: $parent.selectedOptions, attr: { id: item.TemplateName}" />-->
                        <label data-bind="text: item.TemplateName, attr: {for: item.TemplateName}" />
                    </div>
                </li>
            </ul>
        </li>
    </ul>
    <div data-bind="text: Selected().length" style="display: inline;padding-right: 5px;"></div><span>templates selected</span>
    <div style="clear: both"></div>
    <input class="add-template-btn" id="Select-template" type="button" value="Select" data-bind="click: addTemplateMapping" />
    <h2>
        Remember, you don't need to map all of your templates at once. You can update and add new templates later
    </h2>
</div>

<script>

    var id = getUrlVars()["id"];
    jQuery.getJSON('/sitecore/api/templates?id={' + id + '}', null, function (data) {
        var viewModel = {
            Projects: ko.observableArray(data.Projects),
            Selected: ko.observableArray(data.Selected)
        };
        ko.applyBindings(viewModel);
    });


   

    addTemplateMapping = function () {
        var dataObject = ko.toJSON(this);
 
        jQuery.ajax({
            url: '/sitecore/api/posttemplates',
            type: 'post',
            data: dataObject,
            contentType: 'application/json',
            success: function () {
                parent.location.reload();
                window.top.dialogClose();
            }
        });
    };

    //TODO use KO
    jQuery(document).ready(function() {
        jQuery(document).on("click", ".project-item", function () {
            jQuery(".project-item").children('ul').hide();
            jQuery(this).children('ul').show();
        });
    });

</script>